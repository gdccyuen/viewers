<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Chat Renderer</title>
    <!-- Markdown libraries from CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            background-color: #e0e0e0;
            padding: 0 15px;
            color: #333;
            border-bottom: 1px solid #ccc;
        }
        
        .status-text {
            font-size: 14px;
            font-weight: 500;
        }
        
        .action-button {
            padding: 5px 15px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .action-button:hover {
            background-color: #3a5a8c;
        }
        
        .action-button:active {
            background-color: #2a4a7c;
        }
        
        /* Main content area */
        .content-area {
            position: relative;
            height: calc(100vh - 40px);
            width: 100%;
        }
        
        /* Text area for JSON input */
        .input-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            background-color: white;
            display: flex;
            flex-direction: column;
            transition: left 0.3s ease;
            overflow: hidden;
        }
        
        .text-area-wrapper {
            position: relative;
            flex-grow: 1;
            width: 100%;
        }
        
        .text-area {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            padding: 15px;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            outline: none;
            background-color: transparent;
            font-family: 'Courier New', monospace;
        }
        
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #aaa;
            text-align: center;
            pointer-events: none;
            width: 80%;
            transition: opacity 0.3s;
        }
        
        /* Rendering area */
        .rendering-container {
            position: absolute;
            top: 0;
            left: 100%;
            width: 100%;
            height: 100%;
            padding: 20px;
            background-color: #f0f8f0;
            overflow-y: auto;
            transition: left 0.3s ease;
            z-index: 10;
        }
        
        .rendering-container.visible {
            left: 0;
        }
        
        /* Chat message styling */
        .chat-container {
            max-width: 100%;
            padding: 10px;
        }
        
        .chat-bubble {
            max-width: 90%;
            margin: 10px 0;
            padding: 12px 16px;
            border-radius: 8px;
            word-wrap: break-word;
            border: 1px solid #d0e8d0;
            background-color: #add8e6; /* Default light blue */
        }
        
        .user-message {
			background-color: #ffffc5; /* light yellow */
            margin-left: auto;
            text-align: left;
        }
        
        .assistant-message {
			background-color: #e8f5e8; /* light green */
            margin-right: auto;
            text-align: left;
        }
        
        .assistant-message.positive-rating {
            background-color: #f0e8ff; /* Light purple */
            border-color: #d0c0ff;
        }
        
        .assistant-message.negative-rating {
            background-color: #ffe8e8; /* Light pink */
            border-color: #ffc0c0;
        }
        
        .message-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .message-content {
            font-size: 15px;
            line-height: 1.5;
        }
        
        .markdown-content {
            font-size: 15px;
            line-height: 1.6;
        }
        
        .markdown-content h1, 
        .markdown-content h2, 
        .markdown-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        
        .markdown-content p {
            margin-bottom: 1em;
        }
        
        .markdown-content ul, 
        .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }
        
        .markdown-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        .markdown-content pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        
        .markdown-content blockquote {
            border-left: 3px solid #ccc;
            padding-left: 10px;
            margin-left: 0;
            color: #666;
        }
        
        /* Annotation styling */
        .annotation-container {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            font-size: 14px;
        }
        
        .rating-line {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .rating-emoji {
            font-size: 16px;
            margin-right: 10px;
        }
        
        .rating-details {
            color: #666;
            font-weight: 500;
        }
        
        .comment-line {
            margin-top: 6px;
            color: #555;
            line-height: 1.4;
        }
        
        .model-id {
            margin-top: 8px;
            font-size: 13px;
            color: #777;
            font-style: italic;
        }
        
        .rating-value {
            margin-left: 10px;
            color: #4a6fa5;
            font-weight: 600;
        }
        
        .chat-separator {
            height: 1px;
            background-color: #ddd;
            margin: 20px 0;
            width: 100%;
        }
        
        /* File drag overlay */
        .file-drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(74, 111, 165, 0.1);
            border: 3px dashed #4a6fa5;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #4a6fa5;
            z-index: 20;
        }
        
        .file-drag-overlay.active {
            display: flex;
        }
        
        /* Error message styling */
        .error {
            color: #c44;
            font-weight: bold;
        }
        
        .success {
            color: #484;
            font-weight: bold;
        }
        
        /* JSON syntax error display */
        .json-error {
            padding: 15px;
            margin: 10px;
            background-color: #ffe6e6;
            border: 1px solid #ff9999;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        /* Chat thread styling */
        .chat-thread {
            margin-bottom: 30px;
        }
        
        .thread-header {
            font-size: 16px;
            font-weight: 600;
            color: #4a6fa5;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #ccc;
        }
        
        .data-rating {
            display: inline-block;
            margin-left: 10px;
            font-size: 13px;
            color: #888;
        }
    </style>
</head>
<body>
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-text">Ready</div>
        <button class="action-button" id="actionBtn">Render</button>
    </div>
    
    <!-- Main Content Area -->
    <div class="content-area">
        <!-- Text Input Area -->
        <div class="input-container">
            <div class="text-area-wrapper">
                <textarea class="text-area" id="jsonInput"></textarea>
                <div class="watermark" id="watermark">
                    Paste JSON data or drag a JSON file here
                </div>
            </div>
        </div>
        
        <!-- Rendering Area -->
        <div class="rendering-container" id="renderingArea">
            <div class="chat-container" id="chatContent">
                <!-- Rendered chat history will appear here -->
            </div>
        </div>
        
        <!-- File Drag Overlay -->
        <div class="file-drag-overlay" id="fileDragOverlay">
            Drop JSON file here
        </div>
    </div>

    <script>
        // DOM elements
        const statusText = document.querySelector('.status-text');
        const actionBtn = document.getElementById('actionBtn');
        const jsonInput = document.getElementById('jsonInput');
        const watermark = document.getElementById('watermark');
        const renderingArea = document.getElementById('renderingArea');
        const chatContent = document.getElementById('chatContent');
        const fileDragOverlay = document.getElementById('fileDragOverlay');
        const inputContainer = document.querySelector('.input-container');
        
        // State variables
        let isRendered = false;
        
        // Configure marked.js for markdown rendering
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false
        });
        
        // Initialize
        function init() {
            updateStatus('Ready');
            setupEventListeners();
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // Action button click
            actionBtn.addEventListener('click', handleActionButtonClick);
            
            // Text area input
            jsonInput.addEventListener('input', handleTextInput);
            
            // File drag and drop
            inputContainer.addEventListener('dragover', handleDragOver);
            inputContainer.addEventListener('dragleave', handleDragLeave);
            inputContainer.addEventListener('drop', handleFileDrop);
            
            // Prevent default drag behaviors
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        }
        
        // Handle action button click
        function handleActionButtonClick() {
            if (!isRendered) {
                renderChatHistory();
            } else {
                clearRendering();
            }
        }
        
        // Parse JSON and extract chat history
        function parseChatHistory(jsonData) {
            try {
                const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
                
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid JSON structure');
                }
                
                // Handle array of chats or single chat object
                const chatElements = Array.isArray(data) ? data : 
                                   (data.snapshot && Array.isArray(data.snapshot)) ? data.snapshot : 
                                   (data.chats && Array.isArray(data.chats)) ? data.chats : 
                                   [data];
                
                const chats = [];
                
                for (const chatElement of chatElements) {
                    try {
                        // Get chat-level data
                        const chatData = chatElement.data || {};
                        const chatRating = chatData.rating;
                        const chatDetailsRating = chatData.details ? chatData.details.rating : null;
                        const chatComment = chatData.comment || "";
                        
                        let messages = null;
                        
                        // Navigate to messages - handle both object and array formats
                        if (chatElement.snapshot && 
                            chatElement.snapshot.chat && 
                            chatElement.snapshot.chat.chat && 
                            chatElement.snapshot.chat.chat.history && 
                            chatElement.snapshot.chat.chat.history.messages) {
                            messages = chatElement.snapshot.chat.chat.history.messages;
                        } else if (chatElement.history && chatElement.history.messages) {
                            messages = chatElement.history.messages;
                        } else if (chatElement.messages) {
                            messages = chatElement.messages;
                        }
                        
                        if (!messages || typeof messages !== 'object') {
                            console.warn('No messages found in chat element');
                            continue;
                        }
                        
                        // Convert messages object to array if it's an object with keys
                        const messageArray = Array.isArray(messages) ? messages : Object.values(messages);
                        
                        if (messageArray.length === 0) {
                            continue;
                        }
                        
                        // Create message map for lookup by ID
                        const messageMap = new Map();
                        for (const msg of messageArray) {
                            if (msg.id) {
                                messageMap.set(msg.id, msg);
                            }
                        }
                        
                        // Find the message with earliest timestamp
                        let earliestMessage = null;
                        for (const msg of messageArray) {
                            if (!earliestMessage || 
                                (msg.timestamp && (!earliestMessage.timestamp || msg.timestamp < earliestMessage.timestamp))) {
                                earliestMessage = msg;
                            }
                        }
                        
                        // If no messages have timestamps, use the first one
                        if (!earliestMessage && messageArray.length > 0) {
                            earliestMessage = messageArray[0];
                        }
                        
                        if (!earliestMessage) {
                            continue;
                        }
                        
                        // Traverse conversation using childrenIds
                        const conversation = [];
                        let currentMessage = earliestMessage;
                        
                        while (currentMessage) {
                            conversation.push({
                                role: currentMessage.role || 'unknown',
                                content: currentMessage.content || '',
                                timestamp: currentMessage.timestamp || null,
                                id: currentMessage.id || null,
                                annotation: currentMessage.annotation || null,
                                model_id: currentMessage.model_id || currentMessage.model || null,
                                childrenIds: currentMessage.childrenIds || []
                            });
                            
                            // Move to next message via childrenIds
                            if (currentMessage.childrenIds && 
                                Array.isArray(currentMessage.childrenIds) && 
                                currentMessage.childrenIds.length > 0) {
                                const nextId = currentMessage.childrenIds[0];
                                currentMessage = messageMap.get(nextId);
                            } else {
                                // End of conversation
                                currentMessage = null;
                            }
                        }
                        
                        if (conversation.length > 0) {
                            chats.push({
                                messages: conversation,
                                data: chatData
                            });
                        }
                        
                    } catch (error) {
                        console.warn('Error processing chat element:', error);
                    }
                }
                
                return {
                    success: true,
                    chats: chats,
                    totalChats: chats.length,
                    totalMessages: chats.reduce((sum, chat) => sum + chat.messages.length, 0)
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: error.message,
                    chats: []
                };
            }
        }
        
        // Render markdown content
        function renderMarkdown(content) {
            try {
                const html = marked.parse(content || '');
                const cleanHtml = DOMPurify.sanitize(html);
                return cleanHtml;
            } catch (error) {
                console.error('Error rendering markdown:', error);
                return content || '';
            }
        }
        
        // Render annotation for assistant messages
        function renderAnnotation(message, chatData) {
            const annotation = message.annotation;
            
            if (!annotation) return '';
            
            const thumb = annotation.rating;
            const rating = annotation.details ? annotation.details.rating : null;
            const comment = annotation.comment || chatData.comment || "";
            const modelId = message.model_id;
            
            let html = `<div class="annotation-container">`;
            
            // Rating line with emoji
            if (thumb !== undefined) {
                const emoji = thumb >= 0 ? 'üëç' : 'üëé';
                html += `<div class="rating-line">`;
                html += `<span class="rating-emoji">${emoji}</span>`;
                html += `<span class="rating-details">Rating: ${thumb}</span>`;
                
                if (rating !== null && rating !== undefined) {
                    html += `<span class="rating-value">(${rating})</span>`;
                }
                
                html += `</div>`;
            }
            
            // Comment - only if it exists
            if (comment && comment.trim() !== '') {
                html += `<div class="comment-line">${comment}</div>`;
            }
            
            // Model ID - always show if available
            if (modelId) {
                html += `<div class="model-id">${modelId}</div>`;
            }
            
            html += `</div>`;
            
            return html;
        }
        
        // Render chat history
        function renderChatHistory() {
            const jsonText = jsonInput.value.trim();
            
            if (!jsonText) {
                updateStatus('Error: No JSON content to render', true);
                return;
            }
            
            chatContent.innerHTML = '';
            
            try {
                const result = parseChatHistory(jsonText);
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                if (result.chats.length === 0) {
                    throw new Error('No chat conversations found in the JSON data');
                }
                
                // Render each chat
                result.chats.forEach((chat, chatIndex) => {
                    const chatElement = document.createElement('div');
                    chatElement.className = 'chat-thread';
                    
                    // Add chat header with data rating if available
                    const chatHeader = document.createElement('div');
                    chatHeader.className = 'thread-header';
                    
                    let headerText = `Conversation ${chatIndex + 1} (${chat.messages.length} messages)`;
                    
                    // Add data rating to header if available
                    if (chat.data && chat.data.rating !== undefined) {
                        const thumb = chat.data.rating >= 0 ? 'üëç' : 'üëé';
                        headerText += `<span class="data-rating">${thumb} </span>`;
                    }
                    
                    chatHeader.innerHTML = headerText;
                    chatElement.appendChild(chatHeader);
                    
                    // Render each message
                    chat.messages.forEach((message) => {
                        const messageElement = document.createElement('div');
                        
                        // Determine message styling
                        let messageClass = `chat-bubble ${message.role === 'user' ? 'user-message' : 'assistant-message'}`;
                        
                        // Add annotation styling for assistant messages with annotation
                        if (message.role === 'assistant' && message.annotation) {
                            const thumb = message.annotation.rating;
                            if (thumb !== undefined) {
                                if (thumb >= 0) {
                                    messageClass += ' positive-rating';
                                } else {
                                    messageClass += ' negative-rating';
                                }
                            }
                        }
                        
                        messageElement.className = messageClass;
                        
                        // Message header
                        const header = document.createElement('div');
                        header.className = 'message-header';
                        
                        const roleText = message.role.charAt(0).toUpperCase() + message.role.slice(1);
                        const timeText = message.timestamp ? ` ‚Ä¢ ${formatTimestamp(message.timestamp)}` : '';
                        
                        header.textContent = `${roleText}${timeText}`;
                        
                        // Message content
                        const contentContainer = document.createElement('div');
                        contentContainer.className = 'message-content';
                        
                        const markdownContent = document.createElement('div');
                        markdownContent.className = 'markdown-content';
                        markdownContent.innerHTML = renderMarkdown(message.content);
                        
                        contentContainer.appendChild(markdownContent);
                        
                        // Add annotation for assistant messages
                        if (message.role === 'assistant' && message.annotation) {
                            const annotationHTML = renderAnnotation(message, chat.data);
                            contentContainer.insertAdjacentHTML('beforeend', annotationHTML);
                        }
                        
                        messageElement.appendChild(header);
                        messageElement.appendChild(contentContainer);
                        chatElement.appendChild(messageElement);
                    });
                    
                    chatContent.appendChild(chatElement);
                    
                    // Add separator between chats
                    if (chatIndex < result.chats.length - 1) {
                        const separator = document.createElement('div');
                        separator.className = 'chat-separator';
                        chatContent.appendChild(separator);
                    }
                });
                
                renderingArea.classList.add('visible');
                isRendered = true;
                actionBtn.textContent = 'Clear';
                updateStatus(`Rendered ${result.totalChats} conversation(s) with ${result.totalMessages} messages`, false, true);
                
            } catch (error) {
                chatContent.innerHTML = `
                    <div class="json-error">
                        <strong>Error parsing JSON:</strong><br>
                        ${error.message}<br><br>
                        <strong>JSON Structure Expected:</strong><br>
                        The JSON should contain chat history with the following structure:<br>
                        - Each chat may have data object with rating, details.rating, and comment<br>
                        - Messages are in: snapshot > chat > chat > history > messages<br>
                        - Messages are objects with message IDs as keys<br>
                        - Each message should have: role, content, childrenIds, timestamp<br>
                        - Assistant messages may have annotation object with rating<br>
                        - Messages are linked via childrenIds to form conversation threads<br>
                        - The conversation starts with the message having earliest timestamp
                    </div>
                `;
                
                renderingArea.classList.add('visible');
                isRendered = true;
                actionBtn.textContent = 'Clear';
                updateStatus(`Error: ${error.message}`, true);
            }
        }
        
        // Format timestamp
        function formatTimestamp(timestamp) {
            try {
                // Handle both Unix timestamps and ISO strings
                const date = new Date(timestamp * 1000 || timestamp);
                if (isNaN(date.getTime())) {
                    return timestamp;
                }
                return date.toLocaleString();
            } catch (error) {
                return timestamp;
            }
        }
        
        // Clear rendering
        function clearRendering() {
            renderingArea.classList.remove('visible');
            chatContent.innerHTML = '';
            isRendered = false;
            actionBtn.textContent = 'Render';
            updateStatus('Ready');
        }
        
        // Handle text input
        function handleTextInput() {
            const hasContent = jsonInput.value.length > 0;
            watermark.style.opacity = hasContent ? '0' : '1';

            if (isRendered && hasContent) {
                clearRendering();
            }
        }
        
        // Handle drag over
        function handleDragOver(e) {
            e.preventDefault();
            fileDragOverlay.classList.add('active');
        }
        
        // Handle drag leave
        function handleDragLeave(e) {
            e.preventDefault();
            if (!inputContainer.contains(e.relatedTarget)) {
                fileDragOverlay.classList.remove('active');
            }
        }
        
        // Handle file drop
        function handleFileDrop(e) {
            e.preventDefault();
            fileDragOverlay.classList.remove('active');
            
            const files = e.dataTransfer.files;
            if (files.length === 0) return;
            
            const file = files[0];
            const fileName = file.name.toLowerCase();
            const isJsonFile = fileName.endsWith('.json');
            
            if (!isJsonFile) {
                updateStatus('Error: Not a JSON file (.json)', true);
                jsonInput.value = '';
                watermark.style.opacity = '1';
                clearRendering();
                return;
            }

            const reader = new FileReader();

            reader.onload = function(event) {
                const fileContent = event.target.result;
                jsonInput.value = fileContent;
                watermark.style.opacity = '0';
                updateStatus('JSON file loaded successfully', false, true);
            };
            
            reader.onerror = function() {
                updateStatus('Error: Failed to read file', true);
            };
            
            reader.readAsText(file);
        }
        
        // Update status text
        function updateStatus(message, isError = false, isSuccess = false) {
            statusText.textContent = message;
            
            if (isError) {
                statusText.className = 'status-text error';
            } else if (isSuccess) {
                statusText.className = 'status-text success';
            } else {
                statusText.className = 'status-text';
            }
        }
        
        // Initialize
        init();
    </script>
</body>
</html>
